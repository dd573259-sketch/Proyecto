{% extends 'main.html' %}
{% load static %}

{% block Contenido %}

<link href="{% static 'css/select2.min.css' %}" rel="stylesheet" />

<div class="container mt-4">
    <h2 class="mb-4">{{ titulo }}</h2>

    <form method="post" id="form-pedido">
        {% csrf_token %}

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-info-circle"></i> Informaci√≥n del Pedido
            </div>
            <div class="card-body">
                {% for campo in form.visible_fields %}
                    <div class="form-group mb-3">
                        <label><strong>{{ campo.label }}:</strong></label>
                        {{ campo }}
                        {% if campo.errors %}
                            <div class="text-danger small mt-1">
                                {{ campo.errors|join:", " }}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-utensils"></i> Platos del Pedido
            </div>
            <div class="card-body" id="contenedor-platos">
                {{ formset_platos.management_form }}

                {% for form_plato in formset_platos %}
                    <div class="border rounded p-3 mb-3 fila-plato bg-light">
                        <div class="row align-items-end">
                            <div class="col-md-6 mb-2">
                                <label><strong>Plato:</strong></label>
                                {{ form_plato.plato }}
                            </div>
                            <div class="col-md-3 mb-2">
                                <label><strong>Cantidad:</strong></label>
                                {{ form_plato.cantidad }}
                            </div>
                            <div class="col-md-3 mb-2">
                                <label><strong>Subtotal:</strong></label>
                                <input type="text" class="form-control subtotal-plato" readonly placeholder="$0">
                            </div>
                        </div>

                        {% if form_plato.instance.pk %}
                            <div class="form-check mt-2">
                                {{ form_plato.DELETE }}
                                <label class="form-check-label text-danger">Eliminar este plato</label>
                            </div>
                        {% endif %}

                        {% for campo_oculto in form_plato.hidden_fields %}
                            {{ campo_oculto }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <div class="card-footer bg-white">
                <button type="button" class="btn btn-outline-warning btn-sm" id="agregar-plato">
                    <i class="fas fa-plus"></i> Agregar otro plato
                </button>
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-success text-white">
                <i class="fas fa-box"></i> Productos del Pedido
            </div>
            <div class="card-body" id="contenedor-productos">
                {{ formset_productos.management_form }}

                {% for form_producto in formset_productos %}
                    <div class="border rounded p-3 mb-3 fila-producto bg-light">
                        <div class="row align-items-end">
                            <div class="col-md-6 mb-2">
                                <label><strong>Producto:</strong></label>
                                {{ form_producto.producto }}
                            </div>
                            <div class="col-md-3 mb-2">
                                <label><strong>Cantidad:</strong></label>
                                {{ form_producto.cantidad }}
                            </div>
                            <div class="col-md-3 mb-2">
                                <label><strong>Subtotal:</strong></label>
                                <input type="text" class="form-control subtotal-producto" readonly placeholder="$0">
                            </div>
                        </div>

                        {% if form_producto.instance.pk %}
                            <div class="form-check mt-2">
                                {{ form_producto.DELETE }}
                                <label class="form-check-label text-danger">Eliminar este producto</label>
                            </div>
                        {% endif %}

                        {% for campo_oculto in form_producto.hidden_fields %}
                            {{ campo_oculto }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <div class="card-footer bg-white">
                <button type="button" class="btn btn-outline-success btn-sm" id="agregar-producto">
                    <i class="fas fa-plus"></i> Agregar otro producto
                </button>
            </div>
        </div>

        <div class="card mb-4 border-primary">
            <div class="card-body d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Total del Pedido:</h4>
                <h3 class="mb-0 text-primary"><strong id="total-general">$0</strong></h3>
            </div>
        </div>

        <div class="text-end mb-5">
            <a href="{% url 'app:listar_pedidos' %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary px-4">Guardar Pedido</button>
        </div>
    </form>
</div>

{% endblock Contenido %}

{% block js %}
<script src="{% static 'js/select2.min.js' %}"></script>

<script>
    // Obtener datos JSON del context
    const preciosPlatos = {{ platos_json|safe|default:"{}" }};
    const preciosProductos = {{ productos_json|safe|default:"{}" }};
    const stockProductos = {{ stock_json|safe|default:"{}" }};

    // --- 1. FUNCIONES CORE ---

    // Inicializa Select2 en los selects visibles
    function activarSelect2() {
        $('.select2').each(function() {
            $(this).select2({
                placeholder: 'Seleccione una opci√≥n',
                allowClear: true,
                width: '100%',
                dropdownParent: $(this).parent()
            });
        });
    }

    // Calcula subtotal de Platos (lee precio de JSON)
    function calcularSubtotalPlato(fila) {
        const selectPlato = fila.find('select[name$="-plato"]');
        const platoId = selectPlato.val();
        const cantidad = parseFloat(fila.find('input[name$="-cantidad"]').val()) || 0;
        const precio = parseFloat(preciosPlatos[platoId]) || 0;
        const subtotal = precio * cantidad;
        fila.find('.subtotal-plato').val('$' + subtotal.toLocaleString('es-CO'));
        return subtotal;
    }

    // Calcula subtotal de Productos (lee precio y stock de JSON)
    function calcularSubtotalProducto(fila) {
        const selectProducto = fila.find('select[name$="-producto"]');
        const productoId = selectProducto.val();
        const cantidad = parseFloat(fila.find('input[name$="-cantidad"]').val()) || 0;
        const precio = parseFloat(preciosProductos[productoId]) || 0;
        const subtotal = precio * cantidad;
        fila.find('.subtotal-producto').val('$' + subtotal.toLocaleString('es-CO'));
        return subtotal;
    }

    // Recalcula el total general sumando todo
    function recalcularTotal() {
        let total = 0;
        $('.fila-plato').each(function() {
            total += calcularSubtotalPlato($(this));
        });
        $('.fila-producto').each(function() {
            total += calcularSubtotalProducto($(this));
        });
        $('#total-general').text('$' + total.toLocaleString('es-CO'));
    }

    // Valida el stock de productos
    function validarStock(fila) {
        const selectProducto = fila.find('select[name$="-producto"]');
        const inputCant = fila.find('input[name$="-cantidad"]');
        const productoId = selectProducto.val();
        const cantidad = parseInt(inputCant.val()) || 0;
        const stock = parseInt(stockProductos[productoId]) || 0;

        if (stock !== undefined && stock > 0) {
            if (cantidad > stock) {
                Swal.fire('Stock insuficiente', `Solo quedan ${stock} unidades`, 'warning');
                inputCant.val(stock);
            }
        }
    }
    function validarDuplicadoPlato(filaActual) {
        const selectActual = filaActual.find('select[name$="-plato"]');
        const platoId = selectActual.val();
        if (!platoId) return false;

        let duplicado = false;
        $('.fila-plato').not(filaActual).each(function() {
            const otroId = $(this).find('select[name$="-plato"]').val();
            if (otroId && otroId === platoId) {
                duplicado = true;
                return false; // break
            }
        });

        if (duplicado) {
            const nombrePlato = selectActual.find('option:selected').text();
            Swal.fire({
                icon: 'warning',
                title: '¬°Plato repetido!',
                html: `El plato <strong>${nombrePlato}</strong> ya est√° en el pedido.<br>
                        Si quieres m√°s cantidad, edita la fila que ya existe üòä`,
                confirmButtonText: 'Entendido'
            });
            selectActual.val('').trigger('change');
            filaActual.find('input[name$="-cantidad"]').val(1);
            filaActual.find('.subtotal-plato').val('');
            recalcularTotal();
        }

        return duplicado;
    }

// Valida si el producto ya fue seleccionado en otra fila
    function validarDuplicadoProducto(filaActual) {
        const selectActual = filaActual.find('select[name$="-producto"]');
        const productoId = selectActual.val();
        if (!productoId) return false;

        let duplicado = false;
        $('.fila-producto').not(filaActual).each(function() {
            const otroId = $(this).find('select[name$="-producto"]').val();
            if (otroId && otroId === productoId) {
                duplicado = true;
                return false; // break
            }
        });

        if (duplicado) {
            const nombreProducto = selectActual.find('option:selected').text();
            Swal.fire({
                icon: 'warning',
                title: '¬°Producto repetido!',
                html: `El producto <strong>${nombreProducto}</strong> ya est√° en el pedido.<br>
                Si quieres m√°s cantidad, edita la fila que ya existe`,
                confirmButtonText: 'Entendido'
            });
            selectActual.val('').trigger('change');
            filaActual.find('input[name$="-cantidad"]').val(1);
                filaActual.find('.subtotal-producto').val('');
            recalcularTotal();
        }

        return duplicado;
    }



    // --- 3. L√ìGICA DIN√ÅMICA (AGREGAR FILAS) ---

    // Reindexa los campos de un formset para que los √≠ndices sean continuos
    function reIndexFormset(selectorFila, prefijo) {
        const filas = $(selectorFila);
        
        filas.each(function(index) {
            // Actualizar campos del formset
            $(this).find('input, select, label').each(function() {
                const elem = $(this);
                
                // Actualizar 'name' atributo
                if (elem.attr('name')) {
                    const oldName = elem.attr('name');
                    const newName = oldName.replace(
                        new RegExp(`(${prefijo}-)\\d+(-)`),
                        `$1${index}$2`
                    );
                    if (oldName !== newName) {
                        elem.attr('name', newName);
                    }
                }
                
                // Actualizar 'id' atributo
                if (elem.attr('id')) {
                    const oldId = elem.attr('id');
                    const newId = oldId.replace(
                        new RegExp(`(id_${prefijo}-)\\d+(-)`),
                        `$1${index}$2`
                    );
                    if (oldId !== newId) {
                        elem.attr('id', newId);
                    }
                }
                
                // Actualizar 'for' atributo
                if (elem.attr('for')) {
                    const oldFor = elem.attr('for');
                    const newFor = oldFor.replace(
                        new RegExp(`(id_${prefijo}-)\\d+(-)`),
                        `$1${index}$2`
                    );
                    if (oldFor !== newFor) {
                        elem.attr('for', newFor);
                    }
                }
            });
        });
    }

    function agregarFila(selectorFila, prefijo, contenedorId, totalFormsId) {
        const totalForms = $(totalFormsId);
        const nuevoIndice = parseInt(totalForms.val());

        // L√≠mite m√°ximo: 10 filas por formset
        const MAX_FILAS = 10;
        if (nuevoIndice >= MAX_FILAS) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('L√≠mite alcanzado', `No puede agregar m√°s de ${MAX_FILAS} elementos.`, 'warning');
            } else {
                alert(`No puede agregar m√°s de ${MAX_FILAS} elementos.`);
            }
            return;
        }
        const ultimaFila = $(selectorFila).last();
        
        // Destruir Select2 en el contenedor para evitar HTML extra al clonar
        $(contenedorId).find('select').select2 && $(contenedorId).find('select').select2('destroy');

        // Clonamos la √∫ltima fila sin eventos
        const nuevaFila = ultimaFila.clone(false);

        // Detectamos √≠ndice anterior (toma el primer input/select disponible)
        const nombrePrimer = ultimaFila.find('select, input').first().attr('name') || '';
        const regexIndice = new RegExp(`${prefijo}-(\\d+)-`);
        const match = nombrePrimer.match(regexIndice);
        const indiceAnterior = match ? parseInt(match[1]) : (nuevoIndice - 1);

        // Actualizamos TODOS los ID y NAME de la nueva fila con el nuevo √≠ndice
        nuevaFila.find('input, select, label').each(function() {
            const elem = $(this);
            
            // Actualizar 'name' atributo
            if (elem.attr('name')) {
                const oldName = elem.attr('name');
                const newName = oldName.replace(
                    new RegExp(`(${prefijo}-)${indiceAnterior}(-)`),
                    `$1${nuevoIndice}$2`
                );
                elem.attr('name', newName);
            }
            
            // Actualizar 'id' atributo
            if (elem.attr('id')) {
                const oldId = elem.attr('id');
                const newId = oldId.replace(
                    new RegExp(`(id_${prefijo}-)${indiceAnterior}(-)`),
                    `$1${nuevoIndice}$2`
                );
                elem.attr('id', newId);
            }
            
            // Actualizar 'for' atributo
            if (elem.attr('for')) {
                const oldFor = elem.attr('for');
                const newFor = oldFor.replace(
                    new RegExp(`(id_${prefijo}-)${indiceAnterior}(-)`),
                    `$1${nuevoIndice}$2`
                );
                elem.attr('for', newFor);
            }
        });

        // Limpiamos los datos de la nueva fila
        nuevaFila.find('input[type=number]').val(1);
        nuevaFila.find('input[type=text]').val('');
        nuevaFila.find('select').val('');
        nuevaFila.find('.form-check').remove(); // No clonar el bot√≥n de eliminar si es de un registro viejo
        nuevaFila.find('input[name$="-id"]').val(''); // Limpiar ID de base de datos

        // A√±adimos bot√≥n para eliminar esta fila (solo para filas nuevas)
        const botonEliminar = `<div class="text-end mt-2"><button type="button" class="btn btn-sm btn-danger btn-remove-fila">Eliminar</button></div>`;
        // si ya existe un contenedor de acciones lo reemplazamos, sino lo agregamos
        if (nuevaFila.find('.btn-remove-fila').length === 0) {
            nuevaFila.append(botonEliminar);
        }

        // Insertar en el DOM
        $(contenedorId).append(nuevaFila);

        // Actualizar contador de Django
        totalForms.val(nuevoIndice + 1);

        // Reindexar el formset completo para mantener √≠ndices continuos
        reIndexFormset(selectorFila, prefijo);

        // Reactivar Select2 en todas las filas
        activarSelect2();

        // Calcular subtotal de la nueva fila y total general
        const filaNueva = $(contenedorId).children().last();
        if (filaNueva.hasClass('fila-plato')) calcularSubtotalPlato(filaNueva);
        if (filaNueva.hasClass('fila-producto')) calcularSubtotalProducto(filaNueva);
        recalcularTotal();
    }

    // Eventos de botones "Agregar" (delegados para asegurar que funcionan aunque el script se cargue antes)
    $(document).on('click', '#agregar-plato', function(e) {
        e.preventDefault();
        agregarFila('.fila-plato', 'detalle_platos', '#contenedor-platos', '#id_detalle_platos-TOTAL_FORMS');
    });

    $(document).on('click', '#agregar-producto', function(e) {
        e.preventDefault();
        agregarFila('.fila-producto', 'detalle_productos', '#contenedor-productos', '#id_detalle_productos-TOTAL_FORMS');
    });

    // --- 4. EVENTOS DE CAMBIO ---

    // Escuchamos cambios en selects y inputs de platos
    $(document).on('change', '.fila-plato select, .fila-plato input', function(e) {
        const fila = $(this).closest('.fila-plato');
        if (fila.length) {
            if ($(this).is('select')) {
                if (validarDuplicadoPlato(fila)) return;
            }
            calcularSubtotalPlato(fila);
            recalcularTotal();
        }
    });

    // Escuchamos cambios en selects e inputs de productos
    $(document).on('change', '.fila-producto select, .fila-producto input', function(e) {
        const fila = $(this).closest('.fila-producto');
        if (fila.length) {
            if ($(this).is('select')) {
                if (validarDuplicadoProducto(fila)) return;
            }
            validarStock(fila);
            calcularSubtotalProducto(fila);
            recalcularTotal();
        }
    });

    // Tambi√©n respondemos al evento select2:select y select2:unselect
    $(document).on('select2:select select2:unselect', '.select2', function() {
        const fila = $(this).closest('.fila-plato, .fila-producto');
        if (fila.length) {
            if (fila.hasClass('fila-plato')) {
                validarDuplicadoPlato(fila);
                calcularSubtotalPlato(fila);
            }
            if (fila.hasClass('fila-producto')) {
                validarDuplicadoProducto(fila);
                validarStock(fila);
                calcularSubtotalProducto(fila);
            }
            recalcularTotal();
        }
    });

    // Eliminar fila (solo filas nuevas). Reindexa y actualiza TOTAL_FORMS
    $(document).on('click', '.btn-remove-fila', function(e) {
        e.preventDefault();
        const fila = $(this).closest('.fila-plato, .fila-producto');
        const esPlato = fila.hasClass('fila-plato');
        const totalFormsSel = esPlato ? '#id_detalle_platos-TOTAL_FORMS' : '#id_detalle_productos-TOTAL_FORMS';
        const selectorFila = esPlato ? '.fila-plato' : '.fila-producto';
        const prefijo = esPlato ? 'detalle_platos' : 'detalle_productos';

        // Remover la fila del DOM
        fila.remove();

        // Decrementar contador
        const totalForms = $(totalFormsSel);
        const nuevo = Math.max(0, parseInt(totalForms.val()) - 1);
        totalForms.val(nuevo);

        // Reindexar las filas restantes
        reIndexFormset(selectorFila, prefijo);

        // Recalcular total
        recalcularTotal();
    });

    // --- 5. INICIO ---
    $(document).ready(function() {
        activarSelect2();
        
        // Delay para asegurar que todos los elementos est√©n listos
        setTimeout(function() {
            recalcularTotal();
        }, 100);
    });
</script>
{% endblock js %}
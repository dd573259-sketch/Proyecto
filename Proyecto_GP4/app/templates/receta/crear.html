{% extends 'main.html' %}
{% load widget_tweaks %}

{% block Contenido %}

<form method="post">
    {% csrf_token %}

    <div class="card card-default">

        <div class="card-header">
            <h4>Crear Receta</h4>
        </div>

        <div class="card-body">

            <!-- FORM RECETA -->
            <div class="form-group">
                {{ form.plato.label_tag }}
                {{ form.plato }}
            </div>

            <hr>

            <h5>Insumos</h5>
            
            {{ formset.management_form }}

            <div id="formset-container">
                {% for form in formset %}
                    <div class="formset-row mb-3 border p-3 rounded">
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.insumo.label_tag }}
                                {{ form.insumo }}
                            </div>
                            <div class="col-md-4">
                                {{ form.cantidad.label_tag }}
                                {{ form.cantidad }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <button type="button" class="btn btn-success" id="add-form">
                + Agregar insumo
            </button>

        </div>

        <div class="card-footer">
            <button type="submit" class="btn btn-primary">
                Guardar
            </button>

            <a href="{% url 'app:listar_receta' %}" class="btn btn-danger">
                Cancelar
            </a>
        </div>

    </div>

</form>

{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const addButton = document.getElementById('add-form');
    const container = document.getElementById('formset-container');
    const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');

    addButton.addEventListener('click', function() {

        let formCount = parseInt(totalForms.value);

        const firstForm = document.querySelector('.formset-row');
        const newForm = firstForm.cloneNode(true);

        newForm.innerHTML = newForm.innerHTML.replace(/-\d+-/g, '-' + formCount + '-');

        container.appendChild(newForm);

        totalForms.value = formCount + 1;
    });

});
</script>

<script>
{% if form.errors or formset.errors %}
    let texto = "";

    {% for field, errors in form.errors.items %}
        {% for error in errors %}
            texto += "{{ error }}\n";
        {% endfor %}
    {% endfor %}

    {% for form in formset %}
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                texto += "{{ error }}\n";
            {% endfor %}
        {% endfor %}
    {% endfor %}

    Swal.fire({
        title: "Error!",
        text: texto,
        icon: "error"
    });
{% endif %}
</script>
{% endblock %}